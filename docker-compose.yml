#version: "3"
services:
  nginx:
    build: ./nginx
    ports:
      - "80:80"
    container_name: nginx
    depends_on:
      - phpfpm
    links:
      - "phpfpm"
      # - "centos"
      # - "phpfpm5"
    #hostname: dev.kg_wbgl.com
    extra_hosts:
      i.md_front.com: 172.19.0.2
      i.md_payment.com: 172.19.0.2
      i.md_service.com: 172.19.0.2
      # i.be_kg_im_chat.com: 172.19.0.2
      # dev.kg_wbgl.com: 172.19.0.2
      # i.kg_hr_report_api.com: 172.19.0.2
      # i.kg_stock_points.com: 172.19.0.2
      # i.system_admin.com: 172.19.0.2
      i.b_backend.com: 172.19.0.2
      # i.b_service.com: 172.19.0.2
      # i.b_front.com: 172.19.0.2
      # i.b_manage.com: 172.19.0.2
      # i.discuz.com: 172.19.0.2
      # i.discuz_new.com: 172.19.0.2
      # i.discuz_ol.com: 172.19.0.2
      # i.plus.com: 172.19.0.2
    #      kpi.fxwork.kugou.net: 172.19.0.7
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
      - /Users/wangdante/D/mydocker/nginx/config/:/etc/nginx/conf.d/
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.2
  phpfpm:
    #image: mydocker-phpfpm-new:v2
    build: ./phpfpm
    container_name: phpfpm
    ports:
      - "9000:9000"
      - "7272:7272"
      - "1238:1238"
      - "1215:1215"
    links:
      - "redis"
      - "mysql"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      PHP_IDE_CONFIG: "serverName=md-service"
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.3
  mysql:
    build: ./mysql
    container_name: mysql
    ports:
      - "3306:3306"
    volumes:
      - /Users/wangdante/D/mydocker/mysql/data/:/var/lib/mysql/
    environment:
      MYSQL_ROOT_PASSWORD: 654321
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.4
  consul:
    build: ./consul
    container_name: consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      jarven:
        ipv4_address: 172.19.0.29
  elasticsearch:
    build: ./elasticsearch
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.28
  kibana:
    build: ./kibana
    container_name: kibana
    depends_on:
      - elasticsearch
    environment:
      - ELASTICSEARCH_HOSTS=http://172.19.0.28:9200
    ports:
      - "5601:5601"
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.27
  fluent-bit:
    build: ./fluent-bit
    container_name: fluent-bit
    depends_on:
      - elasticsearch
    ports:
      - "24224:24224"
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
      - ./fluent-bit/parsers.conf:/fluent-bit/etc/parsers.conf
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.26
  jaeger:
    build: ./jaeger
    container_name: jaeger
    ports:
      - "16686:16686"
      - "4317:4317"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.25
  jh_gateway:
    build: ./jh_gateway
    container_name: jh_gateway
    ports:
      - "8000:8000"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      - CONSUL_ADDR=consul:8500
    # 必须等待 Consul 容器处于"健康"状态
    depends_on:
      consul:
        condition: service_healthy
      jh_user_service:
        condition: service_started
    restart: always
    stdin_open: true
    tty: true
    networks:
      jarven:
        ipv4_address: 172.19.0.30
  jh_admin_service:
    build: ./jh_admin_service
    container_name: jh_admin_service
    ports:
      - "8001:8001"
      - "8002:8002"
      - "2345:2345"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      - CONSUL_ADDR=consul:8500
      - SERVICE_ADDR=admin-service
    depends_on:
      consul:
        condition: service_healthy
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.31
  node:
    build: ./node
    container_name: node
    ports:
      - "9555:9555"
      - "9556:9556"
      - "9557:9557"
      - "9558:9558"
      - "9559:9559"
      - "9560:9560"
      - "9527:9527"
      - "5777:5777"
    links:
      - "nginx"
    extra_hosts:
      i.go_backend.com: 172.19.0.2
      i.md_front.com: 172.19.0.2
      i.md_payment.com: 172.19.0.2
      i.md_service.com: 172.19.0.2
      i.plus.com: 172.19.0.2
      i.be_kg_im_chat.com: 172.19.0.2
      dev.kg_wbgl.com: 172.19.0.2
      kpi.kugou.net: 172.19.0.2
      i.kg_hr_report_api.com: 172.19.0.2
      mnpm.test.tmeoa.com: 10.130.64.32
      oasp.test.tmeoa.com: 10.130.64.32
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
      # - /var/www/html/by_new/go_backend/node_modules
    # privileged: true #完全控制
    # user: root   #root权限
    stdin_open: true
    tty: true
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.5
  redis:
    build: ./redis
    container_name: redis
    ports:
      - "6379:6379"
    command: >
      redis-server
      --appendonly yes
      --requirepass 654321
    volumes:
      - redis-data:/data
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.6
  redisinsight:
    build: ./redisinsight
    container_name: redisinsight
    ports:
      - "5540:5540"
    depends_on:
      - redis
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.24
  #    volumes:
  #      - /Users/wangdante/D/mydocker/redis/data:/var/docker/redis/
  swagger:
    build: ./swagger
    container_name: swagger
    ports:
      - "8800:8080"
    volumes:
      - /Users/wangdante/D/kugou/hl/hl_service/backendapi/openapi.yaml:/openapi.yml
    environment:
      - SWAGGER_JSON=/openapi.yml
    platform: linux/arm64/v8
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.19

# 自定义网络
networks:
  jarven:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.19.0.0/16
          gateway: 172.19.0.1
volumes:
  es_data:
  redis-data:

