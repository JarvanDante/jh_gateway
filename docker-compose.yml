#version: "3"
services:
  nginx:
    build: ./nginx
    ports:
      - "80:80"
    container_name: nginx
    depends_on:
      - phpfpm
    links:
      - "phpfpm"
      # - "centos"
      # - "phpfpm5"
    #hostname: dev.kg_wbgl.com
    extra_hosts:
      i.md_front.com: 172.19.0.2
      i.md_payment.com: 172.19.0.2
      i.md_service.com: 172.19.0.2
      # i.be_kg_im_chat.com: 172.19.0.2
      # dev.kg_wbgl.com: 172.19.0.2
      # i.kg_hr_report_api.com: 172.19.0.2
      # i.kg_stock_points.com: 172.19.0.2
      # i.system_admin.com: 172.19.0.2
      i.b_backend.com: 172.19.0.2
      # i.b_service.com: 172.19.0.2
      # i.b_front.com: 172.19.0.2
      # i.b_manage.com: 172.19.0.2
      # i.discuz.com: 172.19.0.2
      # i.discuz_new.com: 172.19.0.2
      # i.discuz_ol.com: 172.19.0.2
      # i.plus.com: 172.19.0.2
    #      kpi.fxwork.kugou.net: 172.19.0.7
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
      - /Users/wangdante/D/mydocker/nginx/config/:/etc/nginx/conf.d/
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.2
  phpfpm:
    #image: mydocker-phpfpm-new:v2
    build: ./phpfpm
    container_name: phpfpm
    ports:
      - "9000:9000"
      - "7272:7272"
      - "1238:1238"
      - "1215:1215"
    links:
      - "redis"
      - "mysql"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      PHP_IDE_CONFIG: "serverName=md-service"
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.3
  mysql:
    build: ./mysql
    container_name: mysql
    ports:
      - "3306:3306"
    volumes:
      - /Users/wangdante/D/mydocker/mysql/data/:/var/lib/mysql/
    environment:
      MYSQL_ROOT_PASSWORD: 654321
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.4
  consul:
    image: consul:latest
    container_name: consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      - CONSUL_BIND_INTERFACE=eth0
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      jarven:
        ipv4_address: 172.19.0.29
  jh_gateway:
    build: ./jh_gateway
    container_name: jh_gateway
    ports:
      - "8000:8000"
      - "2345:2345"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      - CONSUL_ADDR=172.19.0.29:8500
    depends_on:
      consul:
        condition: service_healthy
      jh_user:
        condition: service_started
    restart: always
    stdin_open: true
    tty: true
    networks:
      jarven:
        ipv4_address: 172.19.0.30
  jh_user:
    build: ./jh_user
    container_name: jh_user
    ports:
      - "8001:8001"
      - "8002:8002"
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
    environment:
      - CONSUL_ADDR=consul:8500
      - SERVICE_ADDR=user-service
    depends_on:
      consul:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      jarven:
        ipv4_address: 172.19.0.31
  node:
    build: ./node
    container_name: node
    ports:
      - "9555:9555"
      - "9556:9556"
      - "9557:9557"
      - "9558:9558"
      - "9559:9559"
      - "9560:9560"
      - "9527:9527"
      - "5777:5777"
    links:
      - "nginx"
    extra_hosts:
      i.go_backend.com: 172.19.0.2
      i.md_front.com: 172.19.0.2
      i.md_payment.com: 172.19.0.2
      i.md_service.com: 172.19.0.2
      i.plus.com: 172.19.0.2
      i.be_kg_im_chat.com: 172.19.0.2
      dev.kg_wbgl.com: 172.19.0.2
      kpi.kugou.net: 172.19.0.2
      i.kg_hr_report_api.com: 172.19.0.2
      mnpm.test.tmeoa.com: 10.130.64.32
      oasp.test.tmeoa.com: 10.130.64.32
    volumes:
      - /Users/wangdante/D/kugou/:/var/www/html/
      # - /var/www/html/by_new/go_backend/node_modules
    # privileged: true #完全控制
    # user: root   #root权限
    stdin_open: true
    tty: true
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.5
  # node20:
  #     build: ./node20
  #     container_name: node20
  #     ports:
  #       - "8848:8848"
  #       - "8850:8850"
  #     extra_hosts:
  #       i.b_service.com: 172.19.0.2
  #     volumes:
  #       - /Users/wangdante/D/kugou/:/var/www/html/
  #     privileged: true #完全控制
  #     user: root   #root权限
  #     stdin_open: true
  #     tty: true
  #     restart: always
  #     networks:
  #       jarven:
  #         ipv4_address: 172.19.0.15
  # node22:
  #     build: ./node22
  #     container_name: node22
  #     ports:
  #       - "8860:8860"
  #       - "8861:8861"
  #     extra_hosts:
  #       i.b_service.com: 172.19.0.2
  #     volumes:
  #       - /Users/wangdante/D/kugou/:/var/www/html/
  #     privileged: true #完全控制
  #     user: root   #root权限
  #     stdin_open: true
  #     tty: true
  #     restart: always
  #     networks:
  #       jarven:
  #         ipv4_address: 172.19.0.41
  # node16:
  #   build: ./node16
  #   container_name: node16
  #   ports:
  #     - "9528:9528"
  #   links:
  #     - "nginx"
  #   extra_hosts:
  #     i.be_kg_im_chat.com: 172.19.0.2
  #     dev.kg_wbgl.com: 172.19.0.2
  #     kpi.kugou.net: 172.19.0.2
  #     mnpm.test.tmeoa.com: 10.130.64.32
  #     oasp.test.tmeoa.com: 10.130.64.32
  #   volumes:
  #     - /Users/wangdante/D/kugou/:/var/www/html/
  #   stdin_open: true
  #   tty: true
  #   restart: always
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.12
  #  node1618:
  #    build: ./node1618
  #    container_name: node1618
  #    ports:
  #      - "9529:9529"
  #      - "5173:5173"
  #    links:
  #      - "nginx"
  #    extra_hosts:
  #      i.be_kg_im_chat.com: 172.19.0.2
  #      dev.kg_wbgl.com: 172.19.0.2
  #      kpi.kugou.net: 172.19.0.2
  #      i.kg_stock_points.com: 172.19.0.2
  #      i.system_admin.com: 172.19.0.2
  #      mnpm.test.tmeoa.com: 10.130.64.32
  #      oasp.test.tmeoa.com: 10.130.64.32
  #    volumes:
  #      - /Users/wangdante/D/kugou/:/var/www/html/
  #    stdin_open: true
  #    platform: linux/amd64
  #    tty: true
  #    # restart: always
  #    networks:
  #      jarven:
  #        ipv4_address: 172.19.0.13
  #  node18alpine:
  #    build: ./node18alpine
  #    container_name: node18alpine
  #    ports:
  #      - "9530:9530"
  #      - "5174:5174"
  #      - "5175:5175"
  #    links:
  #      - "nginx"
  #    extra_hosts:
  #      i.be_kg_im_chat.com: 172.19.0.2
  #      dev.kg_wbgl.com: 172.19.0.2
  #      kpi.kugou.net: 172.19.0.2
  #      i.kg_stock_points.com: 172.19.0.2
  #      i.system_admin.com: 172.19.0.2
  #      mnpm.test.tmeoa.com: 10.130.64.32
  #      oasp.test.tmeoa.com: 10.130.64.32
  #    volumes:
  #      - /Users/wangdante/D/kugou/:/var/www/html/
  #    stdin_open: true
  #    # 真正root权限
  #    privileged: true
  #    tty: true
  #    # restart: always
  #    networks:
  #      jarven:
  #        ipv4_address: 172.19.0.14
  #  node20alpine:
  #    build: ./node20alpine
  #    container_name: node20alpine
  #    ports:
  #      - "5176:5176"
  #    links:
  #      - "nginx"
  #    extra_hosts:
  #      i.be_kg_im_chat.com: 172.19.0.2
  #      dev.kg_wbgl.com: 172.19.0.2
  #      kpi.kugou.net: 172.19.0.2
  #      i.kg_stock_points.com: 172.19.0.2
  #      i.system_admin.com: 172.19.0.2
  #      mnpm.test.tmeoa.com: 10.130.64.32
  #      oasp.test.tmeoa.com: 10.130.64.32
  #    volumes:
  #      - /Users/wangdante/D/kugou/:/var/www/html/
  #    stdin_open: true
  #    # 真正root权限
  #    privileged: true
  #    tty: true
  #    # restart: always
  #    networks:
  #      jarven:
  #        ipv4_address: 172.19.0.15
  redis:
    build: ./redis
    container_name: redis
    ports:
      - "6379:6379"
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.6
  #    volumes:
  #      - /Users/wangdante/D/mydocker/redis/data:/var/docker/redis/
  swagger:
    build: ./swagger
    container_name: swagger
    ports:
      - "8800:8080"
    volumes:
      - /Users/wangdante/D/kugou/hl/hl_service/backendapi/openapi.yaml:/openapi.yml
    environment:
      - SWAGGER_JSON=/openapi.yml
    platform: linux/arm64/v8
    restart: always
    networks:
      jarven:
        ipv4_address: 172.19.0.19
  # centos:
  #   build: ./centos
  #   container_name: centos
  #   ports:
  #     - "3702:3702"
  #     - "9001:9001"
  #     - "9032:22"
  #   links:
  #     - "mysql"
  #   hostname: i.partkpi.com
  #   extra_hosts:
  #     i.partkpi.com: 172.19.0.5
  #   volumes:
  #     - /Users/wangdante/D/kugou/:/var/www/html/
  #   stdin_open: true
  #   tty: true
  #   # restart: always
  #   privileged: true
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.7
  # go:
  #  build: ./go
  #  container_name: go
  #  ports:
  #    - "9030:9030"
  #    - "9031:9031"
  #    - "8003:8002"
  #    - "9033:22"
  #    - "8900:8900"
  #  links:
  #    - "mysql"
  #    # - "rocketmqserver"
  #  volumes:
  #    - /Users/wangdante/D/kugou/:/var/www/html/
  #  stdin_open: true
  #  tty: true
  #  # restart: always
  #  privileged: true
  #  networks:
  #    jarven:
  #      ipv4_address: 172.19.0.9
  # go25:
  #  build: ./go25
  #  container_name: go25
  #  ports:
  #    - "9060:9060"
  #    - "8888:8888"
  #  links:
  #    - "mysql"
  #    - "redis"
  #  volumes:
  #    - /Users/wangdante/D/kugou/:/var/www/html/
  #  stdin_open: true
  #  tty: true
  #  restart: always
  #  privileged: true
  #  networks:
  #    jarven:
  #      ipv4_address: 172.19.0.51
  # hyperf:
  #   build: ./hyperf
  #   container_name: hyperf
  #   ports:
  #     - "9501:9501"
  #   volumes:
  #    - /Users/wangdante/D/kugou/hyperf/hyperf-skeleton:/hyperf-skeleton
  #   privileged: true #完全控制
  #   user: root   #root权限
  #   restart: on-failure
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.31
  # django18:
  #   build: ./django18
  #   container_name: django18
  #   ports:
  #     - "8080:8080"
  #     - "9022:22"
  #   links:
  #     - "mysql"
  #   volumes:
  #     - /Users/wangdante/D/kugou/:/var/www/html/
  #   stdin_open: true
  #   tty: true
  #   restart: always
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.8

  # clickhouse:
  #   build: ./clickhouse
  #   container_name: clickhouse
  #   ports:
  #     - "8123:8123"
  #     - "9091:9000"
  #   volumes:
  #     - /Users/wangdante/D/mydocker/clickhouse/config/docker_related_config.xml:/etc/clickhouse-server/config.d/docker_related_config.xml:rw
  #     - /Users/wangdante/D/mydocker/clickhouse/config/config.xml:/etc/clickhouse-server/config.xml:rw
  #     - /Users/wangdante/D/mydocker/clickhouse/config/users.xml:/etc/clickhouse-server/users.xml:rw
  #     - /Users/wangdante/D/mydocker/clickhouse/file/:/etc/file/
  #   stdin_open: true
  #   tty: true
  #   # restart: always //先关闭
  #   privileged: true
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.10
  # jupyter:
  #   build: ./jupyter
  #   container_name: jupyter
  #   ports:
  #     - "8888:8888"
  #     - "8889:8889"
  #   links:
  #     - "mysql"
  #   volumes:
  #     - /Users/wangdante/D/mydocker/jupyter/data/:/home/docker_worker/work
  #   command: "start-notebook.sh"
  #   environment:
  #       - NB_USER=docker_worker
  #       - NB_UID=1008
  #       - NB_GID=1011
  #       - CHOWN_HOME=yes
  #       - CHOWN_HOME_OPT=-R
  #       - JUPYTER_TOKEN=easy
  #   # restart: always //先关闭
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.11
#  gonew:
#    build: ./gonew
#    container_name: gonew
#    ports:
#      - "9070:9070"
#      - "40000:40000"
#      - "8881:8881"
#      - "8882:8882"
#      - "8883:8883"
#    #安全特性
#    cap_add:
#     - SYS_PTRACE
#    links:
#      - "mysql"
#      # - "rocketmqserver"
#    volumes:
#      - /Users/wangdante/D/kugou/:/var/www/html/
#    stdin_open: true
#    platform: linux/arm64/v8
#    tty: true
#    # restart: always
#    privileged: true
#    networks:
#      jarven:
#        ipv4_address: 172.19.0.12
# zookeeper:
#   build: ./zookeeper
#   container_name: zookeeper
#   ports:
#     - "2181:2181"
#   volumes:
#    - /Users/wangdante/D/kugou/:/var/www/html/
#   restart: always
#   networks:
#     jarven:
#       ipv4_address: 172.19.0.18
# kafka:
#   build: ./kafka
#   container_name: kafka
#   ports:
#     - "9193:9093"
#   environment:
#     KAFKA_ADVERTISED_HOST_NAME: 127.0.0.1
#     KAFKA_MESSAGE_MAX_BYTES: 2000000
#     KAFKA_CREATE_TOPICS: "Topic1:1:3,Topic2:1:1:compact"
#     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
#   volumes:
#    - /Users/wangdante/D/kugou/:/var/www/html/
#   restart: always
#   networks:
#     jarven:
#       ipv4_address: 172.19.0.16
# kafka-manager:
#   build: ./kafka-manager
#   container_name: kafka-manager
#   ports:
#     - "9020:9000"
#   environment:
#     ZK_HOSTS: zookeeper:2181
#   volumes:
#    - /Users/wangdante/D/kugou/:/var/www/html/
#   restart: always
#   networks:
#     jarven:
#       ipv4_address: 172.19.0.17
# jeager:
#   build: ./jeager
#   container_name: jeager
#   environment:
#       - COLLECTOR_ZIPKIN_HTTP_PORT=9411
#   ports:
#     - "5775:5775/udp"
#     - "6831:6831/udp"
#     - "6832:6832/udp"
#     - "5778:5778"
#     - "16686:16686"
#     - "14268:14268"
#     - "9411:9411"
#   volumes:
#    - /Users/wangdante/D/kugou/:/var/www/html/
#   restart: always
#   networks:
#     jarven:
#       ipv4_address: 172.19.0.20
# prometheus:
#     build: ./prometheus
#     container_name: prometheus
#     hostname: prometheus
#     ports:
#           - "9090:9090"
#     volumes:
#     - /Users/wangdante/D/kugou/:/var/www/html/
#     - /Users/wangdante/D/mydocker/prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml
#     - /Users/wangdante/D/mydocker/prometheus/config/node_down.yml:/etc/prometheus/node_down.yml
#     restart: always
#     networks:
#       jarven:
#         ipv4_address: 172.19.0.21
# alertmanager:
#     build: ./alertmanager
#     container_name: alertmanager
#     hostname: alertmanager
#     ports:
#           - "9093:9093"
#     volumes:
#     - /Users/wangdante/D/mydocker/prometheus/config/alertmanager.yml:/etc/alertmanager/alertmanager.yml
#     restart: always
#     networks:
#       jarven:
#         ipv4_address: 172.19.0.22
# grafana:
#       build: ./grafana
#       container_name: grafana
#       hostname: grafana
#       ports:
#             - "3000:3000"
#       restart: always
#       networks:
#         jarven:
#           ipv4_address: 172.19.0.23
# cadvisor:
#     build: ./cadvisor
#     container_name: cadvisor
#     hostname: cadvisor
#     ports:
#           - "8080:8080"
#     # volumes:
#     # - /:/rootfs:ro
#     # - /var/run:/var/run:rw
#     # - /sys:/sys:ro
#     # - /var/lib/docker/:/var/lib/docker:ro
#     restart: always
#     networks:
#       jarven:
#         ipv4_address: 172.19.0.24
# node-exporter:
#     build: ./node-exporter
#     container_name: node-exporter
#     hostname: node-exporter
#     ports:
#           - "9100:9100"
#     restart: always
#     networks:
#       jarven:
#         ipv4_address: 172.19.0.25
# 自定义网络
networks:
  jarven:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.19.0.0/16
          gateway: 172.19.0.1
  # node2:
  #   build: ./node
  #   container_name: node
  #   ports:
  #     - "9556:9556"
  #     - "9557:9557"
  #   links:
  #     - "nginx"
  #   volumes:
  #     - /Users/wangdante/D/kugou/:/var/www/html/
  #   stdin_open: true
  #   tty: true
  #   restart: always
  #   dns:
  #     - 8.8.8.8
  #     - 223.5.5.5
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.10
  # python3:
  #   build: ./python3
  #   container_name: python3
  #   ports:
  #     - "8001:8080"
  #     - "8888:8888"
  #     - "9042:22"
  #   links:
  #     - "mysql"
  #   volumes:
  #     - /Users/wangdante/D/kugou/:/var/www/html/
  #   stdin_open: true
  #   tty: true
  #   restart: always
  #   privileged: true
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.11
  # gocts:
  #   build: ./gocts
  #   container_name: gocts
  #   ports:
  #     - "9040:9040"
  #     - "9041:9041"
  #     - "9142:22"
  #   links:
  #     - "mysql"
  #   volumes:
  #     - /Users/wangdante/D/kugou/:/var/www/html/
  #   stdin_open: true
  #   tty: true
  #   restart: always
  #   platform: linux/x86_64
  #   privileged: true
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.12
  # centos79:
  #   build: ./centos79
  #   container_name: centos79
  #   ports:
  #     - "9050:9050"
  #     - "9058:8088"
  #     - "9152:22"
  #   links:
  #     - "mysql"
  #   volumes:
  #     - /Users/wangdante/D/kugou/:/var/www/html/
  #   stdin_open: true
  #   tty: true
  #   restart: always
  #   platform: linux/x86_64
  #   privileged: true
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.13
  # phpfpm5:
  #   build: ./phpfpm5
  #   container_name: phpfpm5
  #   ports:
  #     - "9009:9000"
  #   links:
  #     - "redis"
  #   volumes:
  #    - /Users/wangdante/D/kugou/:/var/www/html/
  #   links:
  #     - "mysql"
  #   restart: always
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.14
  # zookeeper:
  #   build: ./zookeeper
  #   container_name: zookeeper
  #   ports:
  #     - "2181:2181"
  #   volumes:
  #    - /Users/wangdante/D/kugou/:/var/www/html/
  #   restart: always
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.18
  # kafka:
  #   build: ./kafka
  #   container_name: kafka
  #   ports:
  #     - "9092:9092"
  #   environment:
  #     KAFKA_ADVERTISED_HOST_NAME: 127.0.0.1
  #     KAFKA_MESSAGE_MAX_BYTES: 2000000
  #     KAFKA_CREATE_TOPICS: "Topic1:1:3,Topic2:1:1:compact"
  #     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  #   volumes:
  #    - /Users/wangdante/D/kugou/:/var/www/html/
  #   restart: always
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.16
  # kafka-manager:
  #   build: ./kafka-manager
  #   container_name: kafka-manager
  #   ports:
  #     - "9020:9000"
  #   environment:
  #     ZK_HOSTS: zookeeper:2181
  #   volumes:
  #    - /Users/wangdante/D/kugou/:/var/www/html/
  #   restart: always
  #   networks:
  #     jarven:
  #       ipv4_address: 172.19.0.17
#   rocketmqserver:
#     build: ./rocketmqserver
#     container_name: rocketmqserver
#     ports:
#       - "9876:9876"
#     volumes:
#      - /Users/wangdante/D/mydocker/rocketmqserver/data/logs:/root/logs
#      - /Users/wangdante/D/mydocker/rocketmqserver/data/store:/root/store
#     environment:
#       MAX_POSSIBLE_HEAP: 100000000
#     command:
#       # 服务启动
#       sh mqnamesrv
# #    restart: always
#     networks:
#       jarven:
#         ipv4_address: 172.19.0.15
#   rocketmqbroker:
#     build: ./rocketmqbroker
#     container_name: rocketmqbroker
#     ports:
#       - "10911:10911"
#       - "10909:10909"
#     volumes:
#      - /Users/wangdante/D/mydocker/rocketmqbroker/data/logs:/root/logs
#      - /Users/wangdante/D/mydocker/rocketmqbroker/data/store:/root/store
#      - /Users/wangdante/D/mydocker/rocketmqbroker/conf/broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf
#     links:
#      - rocketmqserver:namesrv
#     depends_on:
#       - rocketmqserver
#     environment:
#       NAMESRV_ADDR: namesrv:9876
#       MAX_POSSIBLE_HEAP: 200000000
#     command:
#       # 服务启动
#       sh mqbroker -c /opt/rocketmq-4.4.0/conf/broker.conf
# #    restart: always
#     networks:
#       jarven:
#         ipv4_address: 172.19.0.16
#   rocketmqconsole:
#     build: ./rocketmqconsole
#     container_name: rocketmqconsole
#     ports:
#       - "19999:8080"
#     links:
#      - rocketmqserver:namesrv
#     depends_on:
#       - rocketmqserver
#     environment:
#       JAVA_OPTS: "-Drocketmq.namesrv.addr=namesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false"
# #    restart: always
#     networks:
#       jarven:
#         ipv4_address: 172.19.0.17

